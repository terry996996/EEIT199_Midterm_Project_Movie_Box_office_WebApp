package com.gmail.terry996996.service;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;

import org.json.JSONArray;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.multipart.MultipartFile;

import com.gmail.terry996996.dao.MovieDAO;
import com.gmail.terry996996.domain.MovieBean;
import com.gmail.terry996996.domain.UserBean;

import jakarta.servlet.http.HttpSession;

public class UploadService {
	
	@Autowired
	private MovieDAO dao;
	
	
	public void importFromJson(MultipartFile file, HttpSession session) throws IOException {
	    String content = new String(file.getBytes(), StandardCharsets.UTF_8); // 讀取檔案內容為字串
	    JSONObject jsonObject = new JSONObject(content); // 轉成 JSON 物件

	    JSONArray movieList = jsonObject.getJSONArray("list");
	    UserBean loginUser = (UserBean) session.getAttribute("user");
	    LocalDateTime now = LocalDateTime.now();

	    for (int i = 0; i < movieList.length(); i++) {
	        JSONObject movieData = movieList.getJSONObject(i);
	        
	        MovieBean movie = new MovieBean();
	        movie.setCountry(movieData.optString("country"));
	        movie.setMovieName(movieData.optString("name"));
	        movie.setApplicant(movieData.optString("issue"));
	        movie.setProdUnit(movieData.optString("produce"));
	        movie.setShowTheaterNum(movieData.optInt("theaterCount"));
	        movie.setBoxOffice(movieData.optLong("tickets"));
	        movie.setSales(movieData.optLong("amounts"));
	        movie.setCreateTime(now);
	        movie.setUpdateTime(now);
	        movie.setCreateName(loginUser != null ? loginUser.getAccount() : "unknown");
	        movie.setUpdateName(loginUser != null ? loginUser.getAccount() : "unknown");

	        dao.save(movie);
	    }
	}

}
