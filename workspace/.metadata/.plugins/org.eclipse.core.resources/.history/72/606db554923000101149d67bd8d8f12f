package com.gmail.terry996996.util;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.gmail.terry996996.dao.MovieDAO;
import com.gmail.terry996996.domain.MovieBean;

@Service
public class CsvImporter {

    @Autowired
    private MovieDAO movieDAO;

    public void importCsv(String csvFilePath) throws IOException {
        // 讀取 CSV 檔案
        try (BufferedReader reader = new BufferedReader(new FileReader(csvFilePath))) {
            String line;
            reader.readLine(); // 跳過標題行

            // 使用能處理單位數月和日的日期格式
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy/M/d");

            while ((line = reader.readLine()) != null) {
                // 使用逗號分隔每一行的欄位
                String[] fields = line.split(",");

                // 確保欄位數量符合預期
                if (fields.length == 8) { // 假設有8個欄位
                    MovieBean movie = new MovieBean();
                    movie.setCountry(fields[0].trim());  // 國別地區
                    movie.setMovieName(fields[1].trim());  // 中文片名
                    movie.setShowtimes(LocalDate.parse(fields[2].trim(), formatter));  // 上映日期 (轉換為 LocalDate)
                    movie.setApplicant(fields[3].trim());  // 申請人
                    movie.setProdUnit(fields[4].trim());  // 出品
                    movie.setShowTheaterNum(Integer.parseInt(fields[5].trim()));  // 上映院數 (轉換為整數)
                    movie.setBoxOffice(Long.parseLong(fields[6].trim().replace(",", "")));  // 銷售票數 (移除千位符號並轉換為整數)
                    movie.setSales(Long.parseLong(fields[7].trim().replace(",", "")));  // 銷售金額 (移除千位符號並轉換為長整數)

                    // 設定時間和使用者
                    movie.setCreateTime(LocalDateTime.now());
                    movie.setCreateName("admin");  // 假設預設為 admin
                    movie.setUpdateTime(LocalDateTime.now());
                    movie.setUpdateName("admin");  // 假設預設為 admin

                    // 儲存至資料庫
                    movieDAO.save(movie);
                } else {
                    System.out.println("錯誤: 這一行的資料格式不正確，跳過處理.");
                }
            }
        }
    }
}
